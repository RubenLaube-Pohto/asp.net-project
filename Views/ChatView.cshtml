@model ChatApp.Controllers.ChatMessagesViewModel
@addTagHelper "*, Microsoft.AspNetCore.Mvc.TagHelpers"
@using ChatApp.Models

<!DOCTYPE html>
<html>
<head>
    <title>ChatApp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- JQuery dependencies for SignalR -->
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.1.0.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/signalr/jquery.signalr-2.2.1.min.js"></script>
    <!-- SignalR script generated by server. Holds hub configuration. -->
    <script src="signalr/hubs"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function(event) {
            var author = prompt("Enter your name: ");

            $("#txtAuthor").val(author)

            $("#txtMessage").focus()

            var chat = $.connection.chatHub;

            // callback from server
            chat.client.messageReceived = function (id, originatorAuthor, text, timestamp) {
                $("#messages").append(`
                    <tr id="${id}">
                        <td name="author" class="w3-right-align" style="width: 10em;">${originatorAuthor}</td>
                        <td name="text">${text}</td>
                        <td name="timestamp" class="w3-right-align">${timestamp}</td>
                        <td><a id="btnDelete" name="${id}" class="material-icons">close</a></td>
                    </tr>`
                )
                .click(deleteMessage)
                $("html, body").animate({ scrollTop: $(document).height() }, 1000)
            };

            // callback from server
            chat.client.messageDeleted = function (id) {
                $("#" + id).remove()
            }

            // send message
            $("#btnSendMessage").click(function () {
                // call to server
                chat.server.send(author, $("#txtMessage").val());
                $("#txtMessage").val("");
                $("#txtMessage").focus();
            });

            // send on "enter"
            $("#txtMessage").keyup(function (event) {
                if (event.keyCode == 13)
                    $("#btnSendMessage").click();
            });

            // delete message
            $("a").click(deleteMessage)

            function deleteMessage(event) {
                let id = event.target.name
                chat.server.delete(id)
            }

            $.connection.hub.logging = true;
            $.connection.hub.start().done(function () {
                chat.server.connect(author);
            });
        })
    </script>
</head>
<body>
    <table id="messages" class="w3-table">
        @foreach (Message msg in Model.OldMessages)
        {
            <tr id="@msg.Id">
                <td name="author" class="w3-right-align" style="width: 10em;">@msg.Author:</td>
                <td name="text">@msg.Text</td>
                <td name="timestamp" class="w3-right-align">@msg.Timestamp</td>
                <td><a id="btnDelete" name="@msg.Id" class="material-icons">close</a></td>
            </tr>
        }
    </table>
    <form asp-action="SendNewMessage" method="post" class="w3-row">
        <input id="txtAuthor" asp-for="NewMessage.Author" class="w3-input w3-border w3-col m2" placeholder="Name" disabled/>
        <span asp-validation-for="NewMessage.Author"></span>
        <input id="txtMessage" asp-for="NewMessage.Text" class="w3-input w3-border w3-col m8" placeholder="Message"/>
        <input id="btnSendMessage" type="button" value="Send" class="w3-btn w3-blue w3-col w3-large m2"/>
    </form>
</body>
</html>
